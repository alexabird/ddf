name: CI

on:
  push:
    branches:
      - master
      - '[0-9]+.[0-9]+.x'  # Patch branches like 2.10.x, 2.9.x
  pull_request_target:
    branches:
      - master
      - 'fork-ci'
      - '[0-9]+.[0-9]+.x'
  schedule:
    # Nightly build on master (same as Jenkins: H H(17-19) * * *)
    - cron: '0 18 * * *'

permissions:
  packages: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MAVEN_OPTS: '-Xmx4G -Xms1G -XX:+ClassUnloadingWithConcurrentMark -Djava.security.egd=file:/dev/./urandom'
  MAVEN_CLI_OPTS: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn'

jobs:
  # Incremental build for PRs
  incremental-build:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # Full history needed for incremental build

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure Maven settings
        uses: s4u/maven-settings-action@v3.0.0
        with:
          servers: |
            [{
              "id": "codice",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.READ_PACKAGES }}"
            },
            {
              "id": "connexta",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.READ_PACKAGES }}"
            }]

      - name: Quick install (skip tests)
        run: mvn install $MAVEN_CLI_OPTS -DskipStatic=true -DskipTests=true

      - name: Incremental build
        run: |
          mvn clean install $MAVEN_CLI_OPTS \
            -P !itests \
            -Dgib.enabled=true \
            -Dgib.referenceBranch=refs/remotes/origin/${{ github.base_ref }}

  # Full build for master/patch branches
  full-build:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Full build (excluding itests)
        run: mvn clean install $MAVEN_CLI_OPTS -P !itests

      - name: Build itest dependencies
        run: |
          mvn install $MAVEN_CLI_OPTS \
            -pl distribution/test/itests/test-itests-common,distribution/test/itests/test-itests-dependencies-app \
            -am \
            -DskipTests=true

      - name: Run DDF Core integration tests
        run: |
          unset JAVA_TOOL_OPTIONS
          mvn install $MAVEN_CLI_OPTS \
            -pl distribution/test/itests/test-itests-ddf-core \
            -nsu

  # DDF Core integration tests (for PRs)
  integration-tests:
    needs: incremental-build
    if: github.event_name == 'pull_request' && needs.incremental-build.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Quick install (skip tests)
        run: mvn install $MAVEN_CLI_OPTS -DskipStatic=true -DskipTests=true

      - name: Run DDF Core integration tests
        run: |
          unset JAVA_TOOL_OPTIONS
          mvn install $MAVEN_CLI_OPTS \
            -pl distribution/test/itests/test-itests-ddf-core \
            -nsu

  # OWASP Dependency Check (PRs)
  dependency-check-pr:
    needs: incremental-build
    if: always() && (needs.incremental-build.result == 'success' || needs.full-build.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure Maven settings
        uses: s4u/maven-settings-action@v3.0.0
        with:
          servers: |
            [{
              "id": "codice",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.READ_PACKAGES }}"
            },
            {
              "id": "connexta",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.READ_PACKAGES }}"
            }]

      - name: OWASP Dependency Check
        run: |
          mvn org.commonjava.maven.plugins:directory-maven-plugin:highest-basedir@directories \
            dependency-check:aggregate $MAVEN_CLI_OPTS \
            -q -pl '!distribution/docs' \
            -P '!itests'

      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
          retention-days: 30

  # OWASP Dependency Check (master/patch branches)
  dependency-check:
    needs: full-build
    if: always() && (needs.incremental-build.result == 'success' || needs.full-build.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure Maven settings
        uses: s4u/maven-settings-action@v3.0.0
        with:
          servers: |
            [{
              "id": "codice",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.READ_PACKAGES }}"
            },
            {
              "id": "connexta",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.READ_PACKAGES }}"
            }]

      - name: OWASP Dependency Check
        run: |
          mvn org.commonjava.maven.plugins:directory-maven-plugin:highest-basedir@directories \
            dependency-check:aggregate $MAVEN_CLI_OPTS \
            -q -pl '!distribution/docs' \
            -P '!itests,owasp-dist'

  # SonarCloud analysis (master only)
  sonarcloud:
    needs: full-build
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarCloud

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn $MAVEN_CLI_OPTS -q \
            -DskipITs \
            -Dcheckstyle.skip=true \
            org.jacoco:jacoco-maven-plugin:prepare-agent \
            sonar:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.organization=codice \
            -Dsonar.projectKey=ddf \
            -Dsonar.exclusions='**/test/**/*,**/itests/**/*,**/*Test*,**/sdk/**/*,**/*.js,**/node_modules/**/*,**/jaxb/**/*,**/wsdl/**/*,**/nces/sws/**/*,**/*.adoc,**/*.txt,**/*.xml' \
            -pl '!distribution/docs' \
            -P '!itests'
        continue-on-error: true  # Don't fail build if SonarCloud upload fails

  # Deploy artifacts (master and patch branches only, in production)
  deploy:
    needs: [full-build, dependency-check]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      (github.ref == 'refs/heads/master' || contains(github.ref, '.x')) &&
      needs.full-build.result == 'success' &&
      needs.dependency-check.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure Maven settings
        uses: s4u/maven-settings-action@v3.0.0
        with:
          servers: |
            [{
              "id": "github",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.GITHUB_TOKEN }}"
            }]

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Deploy
        run: |
          mvn deploy $MAVEN_CLI_OPTS \
            -DskipStatic=true \
            -DskipTests=true \
            -DretryFailedDeploymentCount=10 \
            -Dreleases.repository.url=https://maven.pkg.github.com/codice/ddf \
            -Dsnapshots.repository.url=https://maven.pkg.github.com/codice/ddf
